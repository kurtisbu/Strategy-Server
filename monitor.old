import requests
import json
import os
import time
from datetime import datetime
from dotenv import load_dotenv

load_dotenv()


def monitor_bot(base_url, interval=60):
    """Monitor the trading bot at regular intervals"""

    while True:
        try:
            print("\n" + "=" * 50)
            print(
                f"Checking bot status at {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
            )
            print("=" * 50)

            response = requests.get(f"{base_url}/monitor")
            data = response.json()

            if response.status_code == 200:
                # Print account summary
                print("\nAccount Summary:")
                print(f"Balance: {data['account_summary']['balance']}")
                print(
                    f"Open Trades: {data['account_summary']['open_trades_count']}"
                )
                print(
                    f"Floating P/L: {data['account_summary']['floating_pl']}")

                # Print open trades
                print("\nOpen Trades:")
                for trade in data['open_trades']:
                    print(f"Trade ID: {trade['id']}")
                    print(f"Instrument: {trade['instrument']}")
                    print(f"Units: {trade['currentUnits']}")
                    print(f"Entry Price: {trade['price']}")
                    if 'stopLossOrder' in trade:
                        print(f"Stop Loss: {trade['stopLossOrder']['price']}")
                    if 'takeProfitOrder' in trade:
                        print(
                            f"Take Profit: {trade['takeProfitOrder']['price']}"
                        )
                    print("-" * 30)

                # Print recent activity
                print("\nRecent Webhooks:")
                for webhook in data['recent_activity']['webhooks'][
                        -5:]:  # Last 5 webhooks
                    print(f"Time: {webhook['timestamp']}")
                    print(f"Data: {webhook['data']}")
                    print("-" * 30)

                # Print recent logs
                print("\nRecent Logs:")
                for log in data['recent_logs'][-5:]:  # Last 5 log entries
                    print(log.strip())

            else:
                print(
                    f"Error getting bot status: {data.get('error', 'Unknown error')}"
                )

        except Exception as e:
            print(f"Error monitoring bot: {str(e)}")

        print(f"\nNext update in {interval} seconds...")
        time.sleep(interval)


if __name__ == "__main__":
    base_url = input("Enter your Replit URL (without /webhook): ")
    monitor_bot(base_url)
