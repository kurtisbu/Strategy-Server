import os
from dotenv import load_dotenv
from oandapyV20 import API
from oandapyV20.endpoints.accounts import AccountSummary
import json
import logging

# Set up logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


def check_oanda_credentials():
    # Load environment variables
    load_dotenv()

    # Get credentials
    api_key = os.getenv('OANDA_API_KEY')
    account_id = os.getenv('OANDA_ACCOUNT_ID')
    environment = os.getenv('OANDA_ENVIRONMENT', 'practice')

    print("\nChecking Oanda Credentials:")
    print("-" * 50)

    # Check if variables exist
    print(f"API Key exists: {bool(api_key)}")
    print(f"Account ID exists: {bool(account_id)}")
    print(f"Environment: {environment}")

    if not api_key or not account_id:
        print("\nError: Missing credentials!")
        print("Please check your .env file or Replit secrets")
        return

    # Print masked credentials for verification
    print(f"\nAPI Key (masked): {api_key[:4]}...{api_key[-4:]}")
    print(f"Account ID (masked): {account_id[:4]}...{account_id[-4:]}")

    try:
        # Initialize API connection
        api = API(access_token=api_key, environment=environment)
        print("\nAPI Connection initialized")

        # Try to get account summary
        r = AccountSummary(account_id)
        print("\nRequesting account summary...")
        response = api.request(r)

        print("\nSuccess! Account details:")
        print("-" * 50)
        print(f"Account Name: {response['account']['alias']}")
        print(f"Currency: {response['account']['currency']}")
        print(f"Balance: {response['account']['balance']}")
        print(f"Open Trades: {response['account']['openTradeCount']}")
        print(f"NAV: {response['account']['NAV']}")

    except Exception as e:
        print("\nError connecting to Oanda:")
        print(f"Error type: {type(e).__name__}")
        print(f"Error message: {str(e)}")
        print("\nTroubleshooting steps:")
        print(
            "1. Verify your API key is for the correct environment (practice/live)"
        )
        print("2. Make sure your Account ID matches the environment")
        print(
            "3. Check if you can log in to Oanda's website with these credentials"
        )
        print("4. Ensure you have permissions for the API key")


if __name__ == "__main__":
    check_oanda_credentials()
